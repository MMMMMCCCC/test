<!DOCTYPE html>
<html>
<head>
    <title>Custom Navigation</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        #map { height: 100%; width: 100%; }
        #travelModeSelector {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ADD8E6;
            padding: 12px;
            border-radius: 8px;
            z-index: 10;
            font-weight: bold;
            font-size: 18px;
            color: #1E90FF;
        }
        #distanceDuration {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 10;
            font-size: 20px;
        }
        .distanceText { color: orange; font-weight: bold; }
        .durationText { color: green; font-weight: bold; }
        #reportBusyBtn {
            position: absolute;
            bottom: 80px; /* Above distanceDuration */
            right: 20px;
            padding: 16px 24px; /* Bigger button */
            font-size: 18px;
            background-color: #FFA500;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="travelModeSelector">
        Travel Mode:
        <select id="travelModeSelect" onchange="calculateRoute()">
            <option value="WALKING" selected>Walking</option>
            <option value="BICYCLING">Bicycling</option>
            <option value="DRIVING">Driving</option>
        </select>
    </div>

    <button id="reportBusyBtn" onclick="reportBusy()">Report Busy</button>

    <div id="distanceDuration">
        <span class="distanceText" id="distance"></span> &nbsp;
        <span class="durationText" id="duration"></span>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN3F8_sdEGAIkhBVDx5ImQLm4SDW5SSlU&libraries=places"></script>
    <script>
        let map, directionsService, directionsRenderer;
        let currentLocation = { lat: 0, lng: 0 };
        let startLocation = { lat: 0, lng: 0 };
        let endLocation = { lat: 0, lng: 0 };
        let redArea = [];
        let busyAreas = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: currentLocation,
                mapTypeId: 'roadmap'
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });

            new google.maps.Marker({
                position: currentLocation,
                map: map,
                title: "You are here",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#0000FF',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF'
                }
            });

            drawRedZones();
            drawBusyAreas();
            calculateRoute();
        }

        function drawRedZones() {
            redArea.forEach(strCoord => {
                const coord = JSON.parse(strCoord);
                const latlng = { lat: coord[0], lng: coord[1] };
                new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF6666',
                    fillOpacity: 0.35,
                    map: map,
                    center: latlng,
                    radius: 50,
                    zIndex: 4
                });
            });
        }

        function drawBusyAreas() {
            busyAreas.forEach(coord => {
                const latlng = { lat: coord[0], lng: coord[1] };
                new google.maps.Circle({
                    strokeColor: '#FFD700',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFFF66',
                    fillOpacity: 0.35,
                    map: map,
                    center: latlng,
                    radius: 50,
                    zIndex: 5
                });
            });
        }

        function calculateRoute() {
            const travelMode = document.getElementById("travelModeSelect").value;

            directionsService.route({
                origin: startLocation,
                destination: endLocation,
                travelMode: travelMode
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    const leg = response.routes[0].legs[0];
                    document.getElementById("distance").innerText = `Distance: ${leg.distance.text}`;
                    document.getElementById("duration").innerText = `Duration: ${leg.duration.text}`;

                    if (window.AppInventor) {
                        window.AppInventor.setWebViewString(JSON.stringify({
                            distance: leg.distance.text,
                            duration: leg.duration.text
                        }));
                    }
                } else {
                    console.error('Directions request failed: ' + status);
                }
            });
        }

        function reportBusy() {
            if (window.AppInventor) {
                window.AppInventor.setWebViewString(JSON.stringify({ reportBusy: true }));
            }
        }

        function receiveParams() {
            const urlParams = new URLSearchParams(window.location.search);

            try {
                currentLocation = JSON.parse(urlParams.get('currentCoords')) || currentLocation;
                const startEnd = JSON.parse(urlParams.get('startAndEndLocation'));
                if (startEnd && startEnd.length === 4) {
                    startLocation = { lat: startEnd[0], lng: startEnd[1] };
                    endLocation = { lat: startEnd[2], lng: startEnd[3] };
                }
                const redData = JSON.parse(urlParams.get('redArea'));
                if (Array.isArray(redData)) redArea = redData;

                const busyData = JSON.parse(urlParams.get('busyAreas'));
                if (Array.isArray(busyData)) busyAreas = busyData;
            } catch (e) {
                console.error("Error parsing URL params", e);
            }
        }

        window.onload = () => {
            receiveParams();
            initMap();
        };
    </script>
</body>
</html>
