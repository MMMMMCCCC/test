<!DOCTYPE html>
<html>
<head>
    <title>Custom Navigation</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        #map {
            height: 100%;
            width: 100%;
        }

        #travelModeSelector {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ADD8E6; /* Light blue */
            padding: 12px;
            border-radius: 8px;
            z-index: 10;
            font-weight: bold;
            font-size: 18px;
            color: #1E90FF; /* Medium blue */
        }

        #distanceDuration {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 10;
            font-size: 20px;
        }

        .distanceText {
            color: orange;
            font-weight: bold;
        }

        .durationText {
            color: green;
            font-weight: bold;
        }

        #reportBusyBtn {
            position: absolute;
            bottom: 80px; /* Above distanceDuration */
            right: 20px;
            padding: 12px 20px;
            font-size: 16px;
            background-color: #FFA500; /* Orange */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="travelModeSelector">
        Travel Mode:
        <select id="travelModeSelect" onchange="calculateRoute()">
            <option value="WALKING" selected>Walking</option>
            <option value="BICYCLING">Bicycling</option>
            <option value="DRIVING">Driving</option>
        </select>
    </div>

    <div id="distanceDuration">
        <span class="distanceText" id="distance"></span> &nbsp;
        <span class="durationText" id="duration"></span>
    </div>

    <button id="reportBusyBtn" onclick="reportBusy()">Report Busy</button>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
    <script>
        let map, directionsService, directionsRenderer;
        let currentLocation = { lat: 0, lng: 0 };
        let startLocation = { lat: 0, lng: 0 };
        let endLocation = { lat: 0, lng: 0 };
        let redArea = [];
        let busyAreas = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: currentLocation,
                mapTypeId: 'roadmap',
                styles: null
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });

            // Current Location Marker (Blue)
            new google.maps.Marker({
                position: currentLocation,
                map: map,
                title: "You are here",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#0000FF',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF'
                }
            });

            drawRedZones();
            drawBusyAreas();
            calculateRoute();
        }

        function drawRedZones() {
            redArea.forEach(strCoord => {
                const coord = JSON.parse(strCoord);
                const latlng = { lat: coord[0], lng: coord[1] };
                new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF6666',
                    fillOpacity: 0.35,
                    map: map,
                    center: latlng,
                    radius: 50,
                    zIndex: 4
                });
            });
        }

        function drawBusyAreas() {
            busyAreas.forEach(coord => {
                const latlng = { lat: coord[0], lng: coord[1] };
                new google.maps.Circle({
                    strokeColor: '#FFD700',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFFF66',
                    fillOpacity: 0.35,
                    map: map,
                    center: latlng,
                    radius: 50,
                    zIndex: 5
                });
            });
        }

        function calculateRoute() {
            const travelMode = document.getElementById("travelModeSelect").value;

            directionsService.route({
                origin: startLocation,
                destination: endLocation,
                travelMode: travelMode,
                avoidPolygons: redArea.map(strCoord => {
                    const coord = JSON.parse(strCoord);
                    return new google.maps.LatLng(coord[0], coord[1]);
                })
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);

                    const leg = response.routes[0].legs[0];
                    document.getElementById("distance").innerText = `Distance: ${leg.distance.text}`;
                    document.getElementById("duration").innerText = `Duration: ${leg.duration.text}`;
                    
                    // Send back to App Inventor if needed
                    const info = {
                        distance: leg.distance.text,
                        duration: leg.duration.text
                    };
                    if (window.AppInventor) {
                        window.AppInventor.setWebViewString(JSON.stringify(info));
                    }
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }

        function reportBusy() {
            if (window.AppInventor) {
                window.AppInventor.setWebViewString(JSON.stringify({ reportBusy: true }));
            }
        }

        function receiveParams() {
            const urlParams = new URLSearchParams(window.location.search);
            currentLocation = JSON.parse(urlParams.get('currentCoords'));
            const startEnd = JSON.parse(urlParams.get('startAndEndLocation'));
            redArea = JSON.parse(urlParams.get('redArea'));

            startLocation = { lat: startEnd[0], lng: startEnd[1] };
            endLocation = { lat: startEnd[2], lng: startEnd[3] };

            // Busy areas from TinyDB (sent from App Inventor)
            if (urlParams.get('busyAreas')) {
                busyAreas = JSON.parse(urlParams.get('busyAreas'));
            }
        }

        window.onload = () => {
            receiveParams();
            initMap();
        };
    </script>
</body>
</html>
