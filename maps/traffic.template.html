<!DOCTYPE html>
<html>
  <head>
    <title>Traffic Map</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      /* Travel-mode dropdown */
      #modeToggle {
        position: absolute; top: 10px; left: 50%;
        transform: translateX(-50%);
        background: #ADD8E6; padding: 12px 16px;
        border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-family: sans-serif; z-index:5;
      }
      #modeToggle label {
        font-size:18px; font-weight:bold; color:#0000CD;
        margin-right:8px;
      }
      #modeToggle select {
        font-size:18px; color:#0000CD; padding:4px;
      }
      /* Info box */
      #infoBox {
        position:absolute; bottom:60px; left:0; width:100%;
        background:rgba(255,255,255,0.9); padding:12px;
        font-family:sans-serif; font-size:20px; text-align:center;
        box-shadow:0 -2px 4px rgba(0,0,0,0.2); z-index:5;
      }
      #infoBox .distance { color:#FF8C00; font-weight:bold }
      #infoBox .duration { color:#008000; font-weight:bold }
      /* Buttons */
      .btn {
        position:absolute; padding:10px 14px; font-size:16px;
        border:none; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
        cursor:pointer; z-index:5; background:#FFD700;
      }
      #reportBusy { bottom: 135px; right: 10px; }
    </style>
    <script>
      let map, directionsService, directionsRenderer;
      let currentCoords, startAndEndLocation, redArea, busyAreas;

      let notifiedDestination = false;
      let selectedMode = 'WALKING';
      let updateCount = 0;
      let distanceService;
      let currentMarker;

      function parseQueryParams() {
        const p = new URLSearchParams(window.location.search);
        const pj = s => JSON.parse(decodeURIComponent(s||'[]'));
        currentCoords       = pj(p.get('currentCoords'));
        startAndEndLocation = pj(p.get('startAndEndLocation'));
        // redArea not shown here for brevity...
        const rawRed = pj(p.get('redArea'));
        const rawBusy= pj(p.get('busyAreas'));
        // parse rawRed & rawBusy:
        redArea = rawRed.map(s => { const a = JSON.parse(s); return { lat: a[1], lng: a[0] }; }).filter(x => x);
        busyAreas = rawBusy.map(a => ({ lat: a[0], lng: a[1] }));
      }

      function initMap() {
        try {
          parseQueryParams();
          const [startLat, startLng, destLat, destLng] = startAndEndLocation;
          map = new google.maps.Map(document.getElementById('map'), {
            center:{lat:currentCoords[0],lng:currentCoords[1]}, zoom:16
          });
          // Traffic layer
          new google.maps.TrafficLayer().setMap(map);
          directionsService  = new google.maps.DirectionsService();
          directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            preserveViewport: true
          });
  
          // Blue marker = current location
          currentMarker = new google.maps.Marker({
            position: { lat: currentCoords[0], lng: currentCoords[1] },
            map: map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: '#4285F4',
              fillOpacity: 1,
              strokeWeight: 2,
              strokeColor: 'white'
            }
          });
          
          // Set up DistanceMatrixService
          distanceService = new google.maps.DistanceMatrixService();
  
          // Danger circles
          redArea.forEach(c => {
            new google.maps.Circle({
              map: map,
              center: c,               // use the object directly
              radius: 600,             // a bit larger for visibility
              strokeColor: '#FF0000',
              strokeOpacity: 0.9,
              strokeWeight: 2,
              fillColor: '#FF6666',
              fillOpacity: 0.4,
              zIndex: 1000             // draw above roads
            });
          });
  
          // Busy-area circles (yellow)
          if (busyAreas.length) busyAreas.forEach(c =>
            new google.maps.Circle({
              map: map,
              center: c,
              radius: 100,               // bigger radius
              strokeColor: '#FFD700',    // bright gold border
              strokeOpacity: 1,          // fully opaque border
              strokeWeight: 2,           // thicker border
              fillColor: '#FFFF00',      // pure yellow fill
              fillOpacity: 0.4,          // more visible
              zIndex: 1002               // above everything else
            })
          );
  
          // Draw walking route
          calculateAndDisplayRoute(startAndEndLocation, selectedMode);
  
          // Travel-mode toggle
          document.getElementById('travelMode')
            .addEventListener('change', e => {
              selectedMode = e.target.value;
              calculateAndDisplayRoute(startAndEndLocation, selectedMode);
            });
  
          // Report Busy button
          // Report Busy button
          document.getElementById('reportBusy')
            .addEventListener('click', () => {
              if (window.AppInventor) {
                window.AppInventor.setWebViewString(JSON.stringify({
                  reportBusy: true,
                  lat: currentCoords[0],
                  lng: currentCoords[1]
                }));
              }
            });  // ← close the click-function and addEventListener
          
          // Check proximity every 5s
          // Inside your initMap(), replace or add the following setInterval section:

          setInterval(() => {
            updateCount++;
          
            // only move marker & update info after the first tick
            if (updateCount > 1) {
              currentMarker.setPosition({
                lat: currentCoords[0],
                lng: currentCoords[1]
              });
          
              distanceService.getDistanceMatrix({
                origins:      [{ lat: currentCoords[0], lng: currentCoords[1] }],
                destinations: [{ lat: destLat,       lng: destLng }],
                travelMode:   selectedMode,
                unitSystem:   google.maps.UnitSystem.METRIC
              }, (response, status) => {
                if (status === 'OK') {
                  const el = response.rows[0].elements[0];
                  document.getElementById('infoBox').innerHTML =
                    `<span class="distance">Distance: ${el.distance.text}</span>` +
                    ` &nbsp;•&nbsp; ` +
                    `<span class="duration">Duration: ${el.duration.text}</span>`;
                }
              });
            }  // ← closes the updateCount > 1 guard
          
            // Check Busy Areas
            busyAreas.forEach(c => {
              const d = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(currentCoords[0], currentCoords[1]),
                new google.maps.LatLng(c.lat, c.lng)
              );
              if (d < 50 && window.AppInventor) {
                window.AppInventor.setWebViewString(JSON.stringify({
                  approachingBusy: true,
                  lat: c.lat,
                  lng: c.lng
                }));
              }
            });
          
            // Check Red (Danger) Zones
            redArea.forEach(c => {
              const d = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(currentCoords[0], currentCoords[1]),
                new google.maps.LatLng(c.lat, c.lng)
              );
              if (d < 50 && window.AppInventor) {
                window.AppInventor.setWebViewString(JSON.stringify({
                  approachingRed: true,
                  lat: c.lat,
                  lng: c.lng
                }));
              }
            });
          
            // Arrival check (only after 3 updates)
            if (updateCount > 3) {
              const destDistance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(currentCoords[0], currentCoords[1]),
                new google.maps.LatLng(destLat, destLng)
              );
              if (!notifiedDestination && destDistance < 30) {
                notifiedDestination = true;
                document.getElementById('destinationOverlay').style.display = 'flex';
                if (window.AppInventor) {
                  window.AppInventor.setWebViewString(
                    JSON.stringify({ reachedDestination: true })
                  );
                }
              }
            }
          }, 1000);
        } catch (e) {
    // Handle any errors initializing the map
          if (window.AppInventor) {
            window.AppInventor.setWebViewString(
              JSON.stringify({ mapInitError: e.message })
            );
          }
          console.error('initMap error:', e);
        }
      }

      function calculateAndDisplayRoute([sLat,sLng,eLat,eLng], mode) {
        directionsService.route({
          origin:{lat:sLat,lng:sLng},
          destination:{lat:eLat,lng:eLng},
          travelMode:mode
        },(res,st)=>{
          if(st==='OK'){
            directionsRenderer.setDirections(res);
            const leg=res.routes[0].legs[0];
            document.getElementById('infoBox').innerHTML=
              `<span class="distance">Distance: ${leg.distance.text}</span>`+
              ` &nbsp;•&nbsp; `+
              `<span class="duration">Duration: ${leg.duration.text}</span>`;
            if(window.AppInventor)
              window.AppInventor.setWebViewString(
                JSON.stringify({
                  distance:leg.distance.text,
                  duration:leg.duration.text
                })
              );
          }
        });
      }
      function hideDestinationOverlay() {
        document.getElementById('destinationOverlay').style.display = 'none';
      }
    </script>
  </head>
  <body>
    <div id="modeToggle">
      <label for="travelMode">Travel Mode:</label>
      <select id="travelMode">
        <option value="WALKING" selected>Walking</option>
        <option value="BICYCLING">Bicycling</option>
        <option value="DRIVING">Driving</option>
      </select>
    </div>
    <div id="map"></div>
    <button id="reportBusy" class="btn">Report Busy</button>
    <div id="infoBox">
      <span class="distance">Distance: --</span> &nbsp;•&nbsp;
      <span class="duration">Duration: --</span>
    </div>
    <div id="destinationOverlay">
      <div class="modal">
        <h2>You’ve reached your destination!</h2>
        <p>Tap “End Navigation” in the app to close.</p>
      </div>
    </div>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=__MAPS_API_KEY__&libraries=geometry&callback=initMap">
    </script>
  </body>
</html>

