<!DOCTYPE html>
<html>
  <head>
    <title>Traffic Map</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      /* Travel-mode dropdown styling */
      #modeToggle {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #ADD8E6;        /* light blue */
        padding: 12px 16px;         /* bigger padding */
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        z-index: 5;
        font-family: sans-serif;
        font-size: 18px;            /* bigger label text */
      }
      #modeToggle select {
        font-size: 18px;            /* bigger dropdown text */
        padding: 4px;
      }

      /* Info box at bottom */
      #infoBox {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255,255,255,0.9);
        padding: 12px;              /* bigger padding */
        font-family: sans-serif;
        font-size: 20px;            /* bigger info text */
        box-shadow: 0 -2px 4px rgba(0,0,0,0.2);
        text-align: center;
        z-index: 5;
      }
      #infoBox .distance {
        color: #FF8C00;             /* medium orange */
        font-weight: bold;
      }
      #infoBox .duration {
        color: #008000;             /* medium green */
        font-weight: bold;
      }
    </style>
    <script>
      let map, directionsService, directionsRenderer;
      let travelMode = 'WALKING';

      function parseQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const parseList = str => JSON.parse(decodeURIComponent(str || '[]'));
        return {
          currentCoords: parseList(params.get('currentCoords')),
          startAndEndLocation: parseList(params.get('startAndEndLocation')),
          redAreaRaw: parseList(params.get('redArea'))
        };
      }

      function initMap() {
        const { currentCoords, startAndEndLocation, redAreaRaw } = parseQueryParams();

        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: currentCoords[0], lng: currentCoords[1] },
          zoom: 16,
          mapTypeId: 'roadmap'
        });

        // Traffic layer (colored roads)
        new google.maps.TrafficLayer().setMap(map);

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map });

        // Blue marker for current location
        new google.maps.Marker({
          position: { lat: currentCoords[0], lng: currentCoords[1] },
          map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: 'white'
          }
        });

        // Draw red danger circles (450 m radius)
        redAreaRaw.forEach(coordStr => {
          try {
            const [lat, lng] = JSON.parse(coordStr);
            new google.maps.Circle({
              strokeColor: '#FF0000',
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: '#FF8888',
              fillOpacity: 0.35,
              map,
              center: { lat, lng },
              radius: 450
            });
          } catch (e) {
            console.error('Invalid circle coord:', coordStr);
          }
        });

        // Initial route
        calculateAndDisplayRoute(startAndEndLocation);

        // Travel-mode toggle handler
        document.getElementById('travelMode')
          .addEventListener('change', function() {
            travelMode = this.value;
            calculateAndDisplayRoute(startAndEndLocation);
          });
      }

      function calculateAndDisplayRoute([startLat, startLng, endLat, endLng]) {
        directionsService.route({
          origin: { lat: startLat, lng: startLng },
          destination: { lat: endLat, lng: endLng },
          travelMode: travelMode
        }, (response, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(response);

            // extract and display distance + duration
            const leg = response.routes[0].legs[0];
            const distText = leg.distance.text;
            const durText  = leg.duration.text;
            document.getElementById('infoBox').innerHTML =
              `<span class="distance">Distance: ${distText}</span>
               &nbsp;•&nbsp;
               <span class="duration">Duration: ${durText}</span>`;

            // send back to App Inventor
            if (window.AppInventor) {
              window.AppInventor.setWebViewString(JSON.stringify({
                distance: distText,
                duration: durText
              }));
            }
          } else {
            alert('Directions request failed: ' + status);
          }
        });
      }
    </script>
  </head>
  <body>
    <!-- Travel-mode dropdown -->
    <div id="modeToggle">
      <label for="travelMode">Travel Mode:</label>
      <select id="travelMode">
        <option value="WALKING" selected>Walking</option>
        <option value="BICYCLING">Bicycling</option>
        <option value="DRIVING">Driving</option>
      </select>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Distance & duration at bottom -->
    <div id="infoBox">
      <span class="distance">Distance: --</span>
      &nbsp;•&nbsp;
      <span class="duration">Duration: --</span>
    </div>

    <!-- Google Maps JS API -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN3F8_sdEGAIkhBVDx5ImQLm4SDW5SSlU&callback=initMap">
    </script>
  </body>
</html>

