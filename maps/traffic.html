<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <title>Traffic Map</title>
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    #travelModeSelector {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:#ADD8E6; padding:12px; border-radius:8px;
      font:bold 18px sans-serif; color:#1E90FF; z-index:10;
    }
    #distanceDuration {
      position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      background:#fff; padding:12px; border-radius:8px;
      font:20px sans-serif; color:#000; z-index:10;
    }
    .distanceText { color:orange; font-weight:bold }
    .durationText { color:green; font-weight:bold }
    #reportBusyBtn {
      position:absolute; bottom:80px; right:20px;
      padding:16px 24px; font:18px sans-serif; background:#FFA500;
      color:#fff; border:none; border-radius:8px; z-index:10;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="travelModeSelector">
    Travel Mode:
    <select id="travelModeSelect" onchange="calculateRoute()">
      <option value="WALKING" selected>Walking</option>
      <option value="BICYCLING">Bicycling</option>
      <option value="DRIVING">Driving</option>
    </select>
  </div>

  <button id="reportBusyBtn" onclick="reportBusy()">Report Busy</button>

  <div id="distanceDuration">
    <span class="distanceText" id="distance">Distance: --</span>
    &nbsp;â€¢&nbsp;
    <span class="durationText" id="duration">Duration: --</span>
  </div>

  <!-- Load Google Maps JS API and call initMap() when ready -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN3F8_sdEGAIkhBVDx5ImQLm4SDW5SSlU&callback=initMap">
  </script>

  <script>
    let map, directionsService, directionsRenderer;
    let currentLocation = {lat:0,lng:0},
        startLocation   = {lat:0,lng:0},
        endLocation     = {lat:0,lng:0},
        redArea         = [],
        busyAreas       = [];

    function initMap() {
      try {
        // 1) Parse URL params
        const p = new URLSearchParams(window.location.search);
        currentLocation = JSON.parse(p.get('currentCoords')||'[0,0]');
        const se = JSON.parse(p.get('startAndEndLocation')||'[0,0,0,0]');
        if (se.length===4) {
          startLocation = {lat:se[0],lng:se[1]};
          endLocation   = {lat:se[2],lng:se[3]};
        }
        redArea   = JSON.parse(p.get('redArea')   || '[]');
        busyAreas = JSON.parse(p.get('busyAreas') || '[]');

        // 2) Create map
        map = new google.maps.Map(document.getElementById('map'), {
          center: currentLocation,
          zoom: 15,
          mapTypeId:'roadmap'
        });
        new google.maps.TrafficLayer().setMap(map);

        // 3) Directions services
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map, suppressMarkers:true
        });

        // 4) Blue marker (you)
        new google.maps.Marker({
          position: currentLocation, map:map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE, scale:8,
            fillColor:'#0000FF', fillOpacity:1,
            strokeWeight:2, strokeColor:'#FFFFFF'
          }
        });

        // 5) Draw danger zones
        redArea.forEach(str => {
          const [lat,lng] = JSON.parse(str);
          new google.maps.Circle({
            strokeColor:'#FF0000', strokeOpacity:0.8, strokeWeight:2,
            fillColor:'#FF6666', fillOpacity:0.35,
            map, center:{lat,lng}, radius:50
          });
        });

        // 6) Draw busy spots
        busyAreas.forEach(arr => {
          const [lat,lng] = arr;
          new google.maps.Circle({
            strokeColor:'#FFD700', strokeOpacity:0.8, strokeWeight:2,
            fillColor:'#FFFF66', fillOpacity:0.35,
            map, center:{lat,lng}, radius:50
          });
        });

        // 7) Initial route draw
        calculateRoute();

      } catch(err) {
        // Show error on device via App Inventor notifier
        if (window.AppInventor) {
          window.AppInventor.setWebViewString(
            JSON.stringify({initError: err.toString()})
          );
        }
        console.error(err);
      }
    }

    function calculateRoute() {
      const mode = document.getElementById('travelModeSelect').value;
      directionsService.route({
        origin: startLocation,
        destination: endLocation,
        travelMode: mode
      }, (res,stat) => {
        if (stat==='OK') {
          directionsRenderer.setDirections(res);
          const leg = res.routes[0].legs[0];
          document.getElementById('distance').innerText = `Distance: ${leg.distance.text}`;
          document.getElementById('duration').innerText = `Duration: ${leg.duration.text}`;
          if (window.AppInventor) {
            window.AppInventor.setWebViewString(
              JSON.stringify({distance:leg.distance.text,duration:leg.duration.text})
            );
          }
        } else {
          console.error('Route error:',stat);
        }
      });
    }

    function reportBusy() {
      if (window.AppInventor) {
        window.AppInventor.setWebViewString(JSON.stringify({reportBusy:true}));
      }
    }
  </script>
</body>
</html>
